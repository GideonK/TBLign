#!/usr/bin/perl -w
use strict;
use FindBin qw($Bin);
use lib $FindBin::Bin.'/../lib';
use List::Util qw[min max];
use Getopt::Std;

use vars qw/$opt_d $opt_l/;
getopt('dl');

unless (defined $ARGV[0]) {
  die ("No devtest score file specified!");
}
unless (defined $opt_l) {
  die ("No output file with levels (-l) specified!");
}
unless (defined $opt_d) {
  die ("No output file with cutoff devtest scores (-d) specified!");
}

open (IN, "<$ARGV[0]") || die ("Could not open devtest scores file ($ARGV[0])!");
open (LOUT, ">$opt_l") || die ("Couldn't open output file with levels ($opt_l)!");
open (DOUT, ">$opt_d") || die ("Couldn't open output file with cutoff devtest scores ($opt_l)!");

my $max=0;
my $score;
my $linecount=-1; ## rule counts begin at 0
my $returnline=0;
my @lines=();

while (my $in=<IN>) {
  if ($in =~ /(\S+)\t\S+$/) {
    push(@lines,$in);
    $linecount++;
    $score=$1;
    $score =~ s/,/\./g;
    if ($score > $max) {
      $max=$score;
      $returnline=$linecount;
    }
    elsif ($score == $max) {
      $returnline=$linecount;
    }
  }
}

print LOUT "Precision (all)\tRecall (all)\tRecall (good)\tRecall (fuzzy)\tF-score (P_all & R_all)\tF-score (P_all & R_good)\n";

for (my $i=0; $i<=$returnline; $i++) {
  if (defined $lines[$i]) {
    print DOUT $lines[$i];
    print LOUT "$i\n";
  }
  else {
    warn ("Defined line $i expected in array \@lines!\n This may lead to the wrong rules being applied when the output file is used. Check code.\n");
  }
}

close (DOUT);
close (LOUT);

__END__

=head1 DESCRIPTION

This script takes as input a text file containing a list of evaluation scores as produced by eval-nonterms.pl, in the context of tree-to-tree alignment (Lingua-Align and Transformation-Based Learning research). The last two columns are F-scores (P_all & R_all and P_all & R_good). We will look at the second last column (P_all & R_all) and return the line containing the highest F-score. If there is more than one highest F-score, we return everything up to the last line containing this score. This then is the last rule to be applied on the test set or on new data that is generated by the training data set, as compared to the development test set.

=head1 AUTHOR

Gideon KotzE<eacute>, E<lt>g.j.kotze@rug.nlE<gt>

=cut
